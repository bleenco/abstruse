<app-header></app-header>

<nav class="nav sub-nav">
  <div class="container">
    <div class="nav-left">
      <span class="nav-item">
        <h1 class="mr15">{{ repo?.full_name }}</h1>
        <span *ngIf="statusBadge" [innerHTML]="statusBadge | safeHtml" class="status-badge-repo"></span>
      </span>
    </div>
    <div class="nav-center"></div>
    <div class="nav-right">
      <div class="group-buttons" *ngIf="userId">
        <button class="group-button" name="btn-builds" [class.is-active]="tab === 'builds'" (click)="tab = 'builds'">Builds</button>
        <button class="group-button" name="btn-settings" [class.is-active]="tab === 'settings'" (click)="tab = 'settings'">Settings</button>
      </div>
    </div>
  </div>
</nav>

<div class="container">
  <div class="columns">
    <div class="column is-12">
      <div class="content">
        <div class="container" *ngIf="loading">
          <img src="images/icons/flickr.svg" class="main-loader">
        </div>

        <div class="columns is-multiline" *ngIf="!loading">
          <div class="column is-12">
            <div class="columns repository-details">
              <div class="column is-8">
                <span>
                  <img src="images/icons/github-white.svg">
                  <a [href]="repo?.html_url">{{ repo?.html_url }}</a>
                </span>
                <span>
                  <img src="images/icons/git-branch.svg">
                  {{ repo?.default_branch }}
                </span>
                <span *ngIf="repo?.private">
                  <img src="images/icons/unlock.svg">
                  Private
                </span>
                <span *ngIf="!repo?.private">
                  <img src="images/icons/unlock.svg">
                  Public Repository
                </span>
              </div>
              <div class="column is-4"></div>
            </div>
          </div>

          <div class="column is-12" *ngIf="!repo?.builds?.length && tab === 'builds'">
            <div class="notification is-info">
              No builds has been runned yet.
            </div>
          </div>

          <div class="column is-12" *ngIf="repo?.builds?.length && tab === 'builds'">
            <div class="columns list-item" *ngFor="let build of repo.builds; let i = index;" [ngClass]="{ 'is-queued': build.status === 'queued', 'is-success': build.status === 'success', 'is-running': build.status === 'running', 'is-errored': build.status === 'failed' }" (click)="gotoBuild(build.id)">
              <app-build-item [build]="build"></app-build-item>
            </div>
            <div layout-align="center" *ngIf="repo?.builds?.length" align="center" class="more-button-container">
              <button type="button" class="button dark" name="btn-loadmore" (click)="fetchBuilds($event)" [class.is-loading]="fetching" [class.is-hidden]="hideMoreButton">
                <img src="images/icons/more.svg">
                Load more builds
              </button>
            </div>
          </div>

          <div class="column is-12" *ngIf="tab === 'settings'">
            <div class="columns">
              <div class="column is-12">
                <div class="settings-container">
                  <h2>Settings</h2>
                  <form class="form" #repoForm="ngForm" (ngSubmit)="saveRepoSettings($event)">
                    <div class="form-field">
                      <label class="form-label" *ngIf="!repo?.bitbucket_id">Access Token</label>
                      <label class="form-label" *ngIf="repo?.bitbucket_id">Access Token (OAuth consumers pair key:secret)</label>
                      <select class="form-input form-select" [(ngModel)]="form.access_tokens_id" name="access_tokens_id">
                        <option *ngFor="let t of tokens" [value]="t.id">{{ t.user.fullname }}`s {{ t.description }}</option>
                      </select>
                    </div>
                    <input type="hidden" name="id" [(ngModel)]="form.id">
                    <div class="form-field">
                      <button type="submit" class="button green float-right" [class.is-loading]="saving" [disabled]="!repoForm.form.valid">Save Repository Settings</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>

          <div class="column is-12" *ngIf="tab === 'settings'">
            <div class="columns">
              <div class="column is-12">
                <div class="settings-container">
                  <h2>Environment Variables</h2>

                  <div class="add-variable">
                    <h3>Add New Variable:</h3>
                    <form class="control-form" (ngSubmit)="addEnvironmentVariable()" #addForm="ngForm">
                      <div class="form-field">
                        <label class="form-label">Name</label>
                        <input class="form-input" type="text" placeholder="Name" name="name" required [(ngModel)]="environmentVariableForm.name">
                      </div>
                      <div class="form-field">
                        <label class="form-label">Value</label>
                        <input class="form-input" type="text" placeholder="Value" name="value" required [(ngModel)]="environmentVariableForm.value">
                      </div>
                      <div class="form-field">
                        <button type="submit" class="button green float-right" name="btn-add-variable" [disabled]="!addForm.form.valid" required>Add New Variable</button>
                      </div>
                    </form>
                  </div>

                  <div class="variables" *ngIf="repo?.variables?.length">
                    <h3>Repository Environment Variables:</h3>
                    <div class="columns list-item list-item-slim" *ngFor="let v of repo?.variables; let i = index;">
                      <div class="column is-10">
                        <span class="bold">{{ v.name }}: {{ v.value }}</span>
                      </div>
                      <div class="column is-2 justify-center">
                          <span class="icon" name="remove-variable" (click)="removeVariable(v.id)">
                            <img src="images/icons/remove.svg">
                          </span>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>
